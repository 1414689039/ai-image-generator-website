# Mileguo AI 生图网站 - 项目交接文档 (Handover Documentation)

本文档旨在帮助后续接手的 AI 助手或开发者快速理解项目架构、服务器环境及数据库设计。

> **核心提示**: 接手本项目的 AI 请注意，本项目深度依赖 Cloudflare 生态 (Workers, Pages, D1, R2)。本地代码只是冰山一角，大量逻辑运行在 Cloudflare 边缘节点上。

## 1. 项目概览 (Project Overview)

*   **项目名称**: AI Image Generator (Mileguo)
*   **线上地址**: `https://mileguo.top`
*   **核心架构**: Serverless 全栈
    *   **Frontend**: React SPA (Cloudflare Pages)
    *   **Backend**: Hono API (Cloudflare Workers)
    *   **Database**: SQLite (Cloudflare D1)
    *   **Storage**: Object Storage (Cloudflare R2)

## 2. 服务器基础设施 (Server Infrastructure)

### A. Cloudflare Workers (后端)
*   **服务名称**: `ai-image-generator-worker`
*   **运行时**: Cloudflare Workers (V8 Isolate)
*   **入口文件**: `worker/src/index.ts`
*   **环境绑定 (Bindings)**:
    *   `DB`: D1 数据库绑定 (`ai-image-db`)
    *   `IMAGES`: R2 存储桶绑定 (`ai-image-uploads-apac`) - **主写入桶**
    *   `IMAGES_OLD`: R2 存储桶绑定 (`ai-image-uploads`) - **备用读取桶**
    *   `CACHE`: KV 命名空间 (目前代码中已定义但未激活)
*   **环境变量 (Vars)**:
    *   `NANO_BANANA_API_URL`: AI 上游 API 地址
    *   `ZPAY_PID`: 支付商户 ID
    *   `PAYMENT_API_URL`: 支付网关地址
    *   `FRONTEND_URL`: 前端回调地址 (用于支付回调)

### B. Cloudflare Pages (前端)
*   **项目名称**: `ai-image-generator-frontend`
*   **构建命令**: `npm run build` (输出目录 `dist`)
*   **路由机制**:
    *   **SPA 路由**: 通过 `public/_redirects` 将所有非 API 请求重定向到 `index.html`。
    *   **反向代理 (Functions)**: `functions/images/[[path]].js` 拦截 `/images/*` 请求，转发给 Worker，实现国内访问加速和流式传输。

### C. 网络拓扑
`用户` -> `Cloudflare CDN` -> `Pages (前端)` -> `Functions (代理)` -> `Worker (后端)` -> `D1 (数据) / R2 (图片)`

## 3. 数据库设计 (Database Schema)

数据库采用 Cloudflare D1 (SQLite)。以下是核心表结构：

### 用户与权限
*   **`users`**: 用户基础信息 (id, username, email, points, is_admin)。
*   **`api_keys`**: (管理员用) 存储上游 AI 服务的 API Key。

### 核心业务
*   **`generations`**: 生图任务表。
    *   `status`: pending (排队) -> processing (生成中) -> completed (完成) / failed (失败)。
    *   `result_urls`: JSON 数组，存储 R2 图片路径。
    *   `is_public`: 是否公开到灵感社区。
    *   `api_task_id`: 上游服务的任务 ID (用于轮询)。
*   **`orders`**: 充值订单表。
*   **`point_transactions`**: 积分流水表 (充值、消费、退款)。

### 社区功能
*   **`gallery_likes`**: 点赞记录 (user_id, generation_id)。
*   **`gallery_unlocks`**: 购买/解锁记录。
*   **`messages`**: 留言板主题。
*   **`replies`**: 留言回复。

### 系统配置
*   **`system_config`**: 动态配置表 (如公告、价格策略)，由管理员后台管理。
*   **`system_logs`**: 系统日志表 (记录错误、支付回调等关键信息)。

## 4. 部署指南 (Deployment Guide)

### 前置条件
*   已安装 Wrangler CLI (`npm install -g wrangler`) 并登录 (`wrangler login`)。
*   **Cloudflare 账号**: `a1414689039@gmail.com`
*   **Account ID**: `940df051167c6c373d01b8927cb36e06`

### 常用命令
| 操作 | 命令 | 说明 |
| :--- | :--- | :--- |
| **部署前端** | `cd frontend && npm run build && wrangler pages deploy dist --project-name ai-image-generator-frontend --branch HEAD` | **必须**指定 HEAD 分支以发布到生产环境 |
| **部署后端** | `cd worker && npm run deploy` | 部署 Worker 代码 |
| **迁移数据库(线上)** | `cd worker && wrangler d1 migrations apply ai-image-db --remote` | 应用最新的 SQL 变更到线上 D1 |
| **迁移数据库(本地)** | `cd worker && wrangler d1 migrations apply ai-image-db --local` | 应用变更到本地测试库 |

> **注意**: Windows PowerShell 用户请注意 `&&` 运算符可能不被支持，建议分步执行命令。

## 5. 关键架构设计 (Critical Architecture)

### A. 图片反向代理 (Image Proxy)
为了绕过 GFW 并隐藏真实存储地址，所有图片访问都通过 `https://mileguo.top/images/*` 进行。Cloudflare Pages Functions 会将流量无缝转发给 Worker，Worker 再从 R2 读取流式返回。

### B. R2 双桶策略 (Dual Bucket Strategy)
*   **写入**: 新生成的图片全部存入 `ai-image-uploads-apac` (亚太区)，以提升国内访问速度。
*   **读取**: 代码实现了自动回退逻辑。先查新桶，若无则查旧桶 `ai-image-uploads` (北美区)。**切勿删除旧桶绑定**。

### C. ZX2 API 适配
针对 ZX2 (52youxi) 接口的不规范响应，后端 `generation.ts` 中包含了一套深度递归搜索逻辑，能自动从复杂的 JSON 中提取出图片 URL，并宽容处理 `processing`/`queue` 等状态。

## 6. 常用资源 ID 速查

*   **D1 Database ID**: `4fd1ed63-08cb-497d-9cb3-4b2d34776e52` (ai-image-db)
*   **R2 Bucket (New)**: `ai-image-uploads-apac`
*   **R2 Bucket (Old)**: `ai-image-uploads`
*   **Worker URL**: `https://ai-image-generator-worker.a1414689039.workers.dev`

---
*Generated by Trae AI - 2026-02-09*
