# 多图参考上传与生成数量排队优化计划

## 1. 前端：支持多图上传参考
- **文件**: `frontend/src/components/GeneratePanel.tsx`
- **任务**:
  - 修改 `referenceImage` 状态为数组 `referenceImages: string[]`。
  - 修改上传 UI，支持展示多张预览图，并提供每张图的删除按钮。
  - 修改 `handleFileUpload` 逻辑，支持一次性处理多个文件（虽然 `input` 是单选，但可以通过多次上传累加）。
  - 在 `handleGenerate` 中传递 `referenceImages` 数组给父组件回调。

## 2. 后端：支持多图处理与修复排队显示
- **文件**: `worker/src/routes/generation.ts`
- **任务 1 (多图支持)**:
  - 接收 `referenceImages` 数组参数。
  - 遍历上传所有参考图到 R2（如果配置了）。
  - 在调用 API 时，将所有参考图放入 `image_urls` 数组中（Gemini 3 Pro 支持多图输入）。
- **任务 2 (排队显示修复)**:
  - **问题分析**: 目前后端对于 Gemini 3 Pro 多张生成采用并发请求，但只创建了一条数据库记录 (`INSERT INTO generations ... quantity`)。前端 `Home.tsx` 中的乐观更新只创建了一个临时项，导致用户只看到一个“排队中”。
  - **方案**:
    - **前端修改 (`Home.tsx`)**: `handleGenerate` 中，如果 `quantity > 1`，创建 `quantity` 个临时项（tempItem），以便用户直观看到多个任务在排队。
    - **后端修改 (`worker/src/routes/generation.ts`)**: 
      - 将并发生成逻辑拆分为创建多条数据库记录。即如果 `quantity=2`，则循环创建 2 条独立的 `generations` 记录，每条 `quantity=1`。
      - 这样每张图都有独立的状态、进度和结果，互不干扰，也符合 Gemini 3 Pro 每次只能生成一张的限制。
      - API 返回结果修改：返回创建的所有 `generationId` 列表，供前端追踪。

## 3. 前后端对接调整
- **前端 (`Home.tsx`)**:
  - 接收后端返回的 `generationIds` 数组。
  - 刷新列表时，这些 ID 对应的真实记录会替换掉之前的临时项。

此方案将“批量生成”拆解为“多个独立任务”，既解决了排队显示问题，也规避了单条记录包含多张图时状态管理的复杂性（如一张成功一张失败）。
