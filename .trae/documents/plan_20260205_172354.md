# 解决手机端支付宝支付回调积分未到账问题

## 问题分析
用户反馈手机端支付宝支付后跳转回来，积分未增加。这通常有几个原因：
1.  **异步通知延迟或失败**: 支付平台的回调 (`notify_url`) 可能被墙、延迟或失败。
2.  **同步跳转处理不足**: 手机 App 支付完成后跳转回 `return_url` (即前端页面)，前端尝试手动触发 `notify` 接口，但可能因为参数缺失或签名验证问题导致失败。
3.  **前端轮询机制**: 前端 `PaymentResult.tsx` 虽然有轮询，但如果手动触发失败且后端异步通知也没到，用户就会一直卡在 "正在查询支付结果"。

## 解决方案

### 1. 增强前端手动触发逻辑 (`PaymentResult.tsx`)
手机端支付跳转回来时，URL 中通常会携带支付结果参数（如 `trade_status`, `sign` 等）。我们需要利用这些参数主动向后端确认支付结果。

*   **当前问题**: 前端代码中 `await apiClient.get('/payment/notify?${searchParams.toString()}')` 尝试手动触发，但如果 URL 参数不完整（某些支付平台跳转回来时不带完整参数，或者参数名不一致），后端签名验证就会失败。
*   **改进**: 
    *   在前端增加更健壮的重试机制。
    *   **关键点**: 如果前端通过 URL 参数验证签名失败，应该尝试直接查询订单状态（这已经在做了）。但更重要的是，后端应该提供一个机制，允许通过 **查询上游支付接口** 来反向确认订单状态，而不是仅依赖回调。

### 2. 后端增加主动查询上游支付状态功能 (`worker/src/routes/payment.ts`)
仅仅依赖 `notify` 回调是不够的。我们需要在用户查询订单状态 (`GET /api/payment/order/:orderNo`) 时，如果订单仍是 `pending`，则**主动去支付平台查询**该订单的实际状态。

*   **新增逻辑**:
    *   修改 `GET /api/payment/order/:orderNo` 接口。
    *   如果订单状态是 `pending`，读取配置中的 `ZPAY_PID` 和 `ZPAY_KEY`。
    *   构造查询请求（通常是 `api.php?act=order&pid={pid}&key={key}&out_trade_no={orderNo}`，具体取决于易支付协议）。
    *   如果查询结果显示已支付 (`TRADE_SUCCESS`)，则立即更新数据库状态并加积分。
    *   这样即使用户的回调丢了，只要用户回到前端页面查询订单，就能触发补单。

## 执行计划
1.  **后端改造**:
    *   在 `payment.ts` 中，为 `GET /order/:orderNo` 增加主动查单逻辑。
    *   实现 `checkPaymentStatusFromUpstream` 函数，调用支付平台的查询接口。
    *   在查询到支付成功后，复用 `handleCallback` 中的加分逻辑（提取为公共函数 `completeOrder`）。
2.  **前端优化**:
    *   优化 `PaymentResult.tsx` 的提示信息，明确告知用户正在与支付平台确认。

此方案能最大程度解决“回调丢失”或“跳转参数不全”导致的问题，实现“查单即补单”。
