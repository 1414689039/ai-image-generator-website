# 如何启动后端服务

## 方法一：使用启动脚本（推荐）

1. 打开 PowerShell
2. 进入项目根目录
3. 运行启动脚本：

```powershell
cd worker
.\start-dev.ps1
```

## 方法二：手动启动

### 步骤 1：进入 worker 目录

```powershell
cd worker
```

### 步骤 2：安装依赖（如果还没安装）

```powershell
npm install
```

### 步骤 3：设置环境变量

在 PowerShell 中设置 JWT_SECRET（必需）：

```powershell
$env:JWT_SECRET="your-secret-key-here"
```

**注意**：`your-secret-key-here` 应该是一个随机生成的字符串，用于加密 JWT 令牌。你可以使用任何字符串，例如：
```powershell
$env:JWT_SECRET="my-super-secret-key-12345"
```

### 步骤 4：初始化本地数据库（首次启动需要）

```powershell
npx wrangler d1 migrations apply ai-image-db --local
```

或者如果已全局安装 wrangler：
```powershell
wrangler d1 migrations apply ai-image-db --local
```

### 步骤 5：启动开发服务器

```powershell
npm run dev
```

或者直接使用 wrangler：
```powershell
npx wrangler dev --local
```

### 步骤 6：验证服务是否启动

服务启动后，默认会在 `http://localhost:8787` 运行。

在浏览器中访问：
```
http://localhost:8787/health
```

应该看到：
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## 完整启动命令示例

```powershell
# 1. 进入 worker 目录
cd worker

# 2. 设置环境变量
$env:JWT_SECRET="dev-secret-key-12345"

# 3. 初始化数据库（仅首次需要）
npx wrangler d1 migrations apply ai-image-db --local

# 4. 启动服务
npm run dev
```

## 常见问题

### Q1: 提示 "wrangler 不是内部或外部命令"
**A**: 使用 `npx wrangler` 代替 `wrangler`，或者全局安装：
```powershell
npm install -g wrangler
```

### Q2: 提示 "Database not found"
**A**: 需要先初始化数据库：
```powershell
npx wrangler d1 migrations apply ai-image-db --local
```

### Q3: 提示 "JWT_SECRET is required" 或 "服务器配置错误"
**A**: 需要设置 JWT_SECRET 环境变量：
```powershell
$env:JWT_SECRET="your-secret-key"
```

### Q4: 端口 8787 被占用
**A**: 
- 关闭占用端口的程序
- 或者修改 `worker/wrangler.toml` 中的端口配置

### Q5: 中文路径问题
**A**: 如果遇到路径编码问题，可以：
- 使用绝对路径
- 或者将项目移动到英文路径下

## 停止服务

在运行服务的终端窗口中按 `Ctrl + C` 停止服务。

## 下一步

服务启动成功后，你可以：
1. 测试注册功能：访问 `http://localhost:3000/register`
2. 测试登录功能：访问 `http://localhost:3000/login`
3. 查看 API 文档：访问 `http://localhost:8787/health`

