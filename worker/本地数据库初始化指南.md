# 本地 D1 数据库初始化指南

## 问题说明

在 Wrangler 4.x 中，本地 D1 数据库需要先初始化才能运行迁移。

## 解决方案（按顺序尝试）

### 方法 1：先启动开发服务器（推荐）

Wrangler 4.x 在首次运行 `wrangler dev --local` 时会自动创建本地数据库。

```powershell
# 1. 启动开发服务器（这会自动创建本地数据库）
npm run dev

# 2. 等待几秒让数据库初始化，然后按 Ctrl+C 停止

# 3. 运行数据库迁移
npm run db:migrate
```

### 方法 2：使用 binding 名称

如果方法 1 不行，尝试使用 binding 名称：

```powershell
npm run db:migrate:binding
```

### 方法 3：直接执行 SQL

如果迁移命令都不行，可以直接执行 SQL 文件：

```powershell
npm run db:init
```

或者手动执行：

```powershell
npx wrangler d1 execute ai-image-db --local --file=./migrations/0001_initial.sql
```

如果使用 database_name 失败，尝试使用 binding：

```powershell
npx wrangler d1 execute DB --local --file=./migrations/0001_initial.sql
```

### 方法 4：使用初始化脚本

运行提供的 PowerShell 脚本：

```powershell
.\init-db-local.ps1
```

这个脚本会自动尝试所有方法。

## 验证数据库是否初始化成功

运行以下命令检查数据库表：

```powershell
npx wrangler d1 execute ai-image-db --local --command="SELECT name FROM sqlite_master WHERE type='table';"
```

或者使用 binding：

```powershell
npx wrangler d1 execute DB --local --command="SELECT name FROM sqlite_master WHERE type='table';"
```

如果看到表列表（users, generations, orders 等），说明初始化成功。

## 常见问题

### Q: 为什么找不到数据库？

A: Wrangler 4.x 的本地数据库需要先通过 `wrangler dev --local` 启动一次才能创建。

### Q: 数据库文件存储在哪里？

A: 本地数据库存储在 `worker/.wrangler/state/v3/d1/` 目录下。

### Q: 如何重置数据库？

A: 删除 `.wrangler` 目录，然后重新初始化：

```powershell
Remove-Item -Recurse -Force .wrangler
npm run dev  # 启动一次以创建数据库
npm run db:migrate  # 运行迁移
```

