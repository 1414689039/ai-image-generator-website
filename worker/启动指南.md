# 后端服务启动指南

## 前置要求

1. 已安装 Node.js 和 npm
2. 已安装 Wrangler CLI：`npm install -g wrangler`
3. 已安装项目依赖：`npm install`

## 启动步骤

### 1. 初始化本地 D1 数据库（首次启动需要）

```powershell
# 进入 worker 目录
cd worker

# 创建本地 D1 数据库（如果还没有创建）
wrangler d1 create ai-image-db --local

# 应用数据库迁移
wrangler d1 migrations apply ai-image-db --local
```

### 2. 设置环境变量

在 PowerShell 中设置环境变量：

```powershell
# 必需的环境变量
$env:JWT_SECRET="your-secret-key-here-change-this-in-production"

# 可选的环境变量（如果使用 AI 生图功能）
$env:NANO_BANANA_API_KEY="your-api-key-here"

# 可选的环境变量（如果使用支付功能）
$env:PAYMENT_API_KEY="your-payment-api-key"
$env:PAYMENT_API_URL="https://your-payment-api-url.com"
```

### 3. 启动开发服务器

```powershell
# 在 worker 目录下运行
wrangler dev --local
```

或者使用 npm 脚本：

```powershell
npm run dev
```

### 4. 验证服务是否启动成功

服务启动后，默认会在 `http://localhost:8787` 运行。

访问健康检查端点：
```
http://localhost:8787/health
```

应该返回：
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## 常见问题

### 问题1：数据库未初始化
**错误信息**：`Database not found` 或类似错误

**解决方法**：
```powershell
wrangler d1 migrations apply ai-image-db --local
```

### 问题2：JWT_SECRET 未设置
**错误信息**：`服务器配置错误` 或 `JWT_SECRET is required`

**解决方法**：
```powershell
$env:JWT_SECRET="your-secret-key-here"
```

### 问题3：端口被占用
**错误信息**：`Port 8787 is already in use`

**解决方法**：
- 关闭占用端口的程序
- 或者修改 `wrangler.toml` 中的端口配置

## 生产环境部署

生产环境部署时，需要在 Cloudflare Dashboard 中：
1. 创建 D1 数据库
2. 创建 R2 存储桶
3. 设置环境变量
4. 运行 `wrangler deploy`

